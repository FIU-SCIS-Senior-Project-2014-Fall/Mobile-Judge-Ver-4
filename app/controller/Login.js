Ext.define("OnlineJudges.controller.Login", { extend: "Ext.app.Controller", config: { views: ["Login", "student.Home"], stores: ["LoginInstance"], refs: { login: { autoCreate: true, selector: "login", xtype: "login" } }, control: { "login #login": { tap: "onLoginTap" }, "studentHome #logoutBtn": { tap: "onLogoutStudentsTap" }, "judgeHome #logoutBtn": { tap: "onLogoutJudgesTap" }, "adminMain #logoutBtn": { tap: "onLogoutJudgesTap" }, "studentHome #studentRolesBtn": { tap: "onStudentRolesBtnTap" } } }, loadMainView: function (e, t) { Ext.Viewport.removeAll().add(Ext.create("widget." + e, Ext.apply({ title: "CIS 4911 Online Judges" }, t || {}))) }, onLoginTap: function () { var e = this, t = e.getLogin().getValues(), n = new Object, r = Ext.getStore("LoginInstance"); r.removeAll(); if (!Ext.isEmpty(t.email) && !Ext.isEmpty(t.password)) { var i = ""; Ext.php.LoginMain.getDefaultRole(t.email, function (n) { if (n.DefaultRole == "student") i = "true"; else i = "false"; if (i === "false") { Ext.php.LoginMain.login(t.email, t.password, function (n) { if (!n) Ext.Msg.alert("Error", "Invalid Username or Password", Ext.emptyFn); else if (n.DefaultRole == "admin") { OnlineJudges.user = n; r.add({ id: 0, email: t.email, password: t.password, roles: n.Roles, defaultrole: n.DefaultRole }); e.loadMainView("adminMain", { title: "Home" }) } else if (n.DefaultRole == "judge") { if (!n.AllowLogin) Ext.Msg.alert("Dear " + n.FirstName, "The grading has not started yet", Ext.emptyFn); else { OnlineJudges.user = n; r.add({ id: 0, email: t.email, password: t.password, roles: n.Roles, defaultrole: n.DefaultRole }); e.loadMainView("judgeHome") } } else if (n.DefaultRole == "student") { token = window.localStorage.getItem("token"); Ext.php.Students.login(token, function (i) { if (Ext.isString(i)) window.location = i; else if (i != null) { OnlineJudges.user = n; r.add({ id: 0, email: t.email, password: t.password, roles: n.Roles, defaultrole: n.DefaultRole }); e.loadMainView("studentHome") } }) } }) } else if (i === "true") { token = window.localStorage.getItem("token"); Ext.php.Students.login(token, function (n) { if (Ext.isString(n)) window.location = n; else if (n != null) { OnlineJudges.user = user; r.add({ id: 0, email: t.email, password: t.password, roles: user.Roles, defaultrole: user.DefaultRole }); e.loadMainView("studentHome") } }) } }) } }, onLogoutStudentsTap: function () { var e = window.localStorage.getItem("token"); window.localStorage.removeItem("token"); OnlineJudges.map = null; Ext.Viewport.removeAll().add(Ext.create("widget.login")); Ext.php.Students.logout(e) }, onLogoutJudgesTap: function () { OnlineJudges.map = null; Ext.Viewport.down("navigationview").getLayout().setAnimation(false); Ext.Viewport.removeAll().add(Ext.create("widget.login")) }, onStudentRolesBtnTap: function () { var e = this, t = Ext.getStore("LoginInstance"), n = t.getById(0), r = new Ext.Panel({ floating: true, centered: true, modal: true, items: [] }); Ext.php.LoginMain.getRoles(n.get("email"), n.get("password"), function (t) { var n = t.Roles.split(";"); for (i = 0; i < n.length; i++) { if (n[i] == "admin") { adminRoleTab = { xtype: "button", text: "Admin", margin: "5", handler: function () { r.hide(); e.loadMainView("adminMain") } }; r.add(adminRoleTab) } else if (n[i] == "judge") { judgeRoleTab = { xtype: "button", text: "Judge", margin: "5", handler: function () { r.hide(); e.loadMainView("judgeHome") } }; r.add(judgeRoleTab) } else if (n[i] == "student") { studentRoleTab = { xtype: "button", text: "Student", margin: "5", handler: function () { r.hide(); e.loadMainView("studentHome") } }; r.add(studentRoleTab) } } }); r.add({ xtype: "button", docked: "bottom", text: "Cancel", handler: function () { r.hide() } }); r.show() } })